.PHONY: help build dev run debug test bench clean fmt lint release docker-build docker-run docker-push install deps update

# Project information
PROJECT_NAME = moltrade-relayer
VERSION = 0.1.0
CARGO = cargo
DOCKER_REGISTRY = docker.io
DOCKER_IMAGE = $(DOCKER_REGISTRY)/moltrade-relayer:latest

# Compilation targets
TARGET_DIR = target
RELEASE_BINARY = $(TARGET_DIR)/release/$(PROJECT_NAME)
DEBUG_BINARY = $(TARGET_DIR)/debug/$(PROJECT_NAME)

# Default target
.DEFAULT_GOAL := help

# ============================================================================
# Help
# ============================================================================
help: ## Display all available commands
	@echo "=================================================================================="
	@echo "$(PROJECT_NAME) v$(VERSION) - Makefile Commands"
	@echo "=================================================================================="
	@echo ""
	@echo "Usage: make [command]"
	@echo ""
	@echo "Build commands:"
	@echo "  make build              - Build release version (optimized, recommended for production)"
	@echo "  make dev                - Build development version (debug mode, fast compile)"
	@echo "  make release            - Build release version and show binary path"
	@echo "  make deps               - Download project dependencies"
	@echo "  make update             - Update all dependencies to latest compatible version"
	@echo ""
	@echo "Run commands:"
	@echo "  make run                - Run release version"
	@echo "  make debug              - Run development version (debug mode)"
	@echo "  make run-with-config    - Run using config file"
	@echo ""
	@echo "Test and check:"
	@echo "  make test               - Run all unit tests"
	@echo "  make test-verbose       - Run tests (with detailed output)"
	@echo "  make bench              - Run benchmark tests"
	@echo "  make fmt                - Auto-format code"
	@echo "  make fmt-check          - Check code format (no modifications)"
	@echo "  make lint               - Run Clippy code check"
	@echo ""
	@echo "Clean commands:"
	@echo "  make clean              - Delete build artifacts"
	@echo "  make clean-db           - Delete RocksDB data files"
	@echo "  make clean-all          - Full cleanup (including dependencies)"
	@echo ""
	@echo "Docker commands:"
	@echo "  make docker-build       - Build Docker image"
	@echo "  make docker-run         - Run Docker container"
	@echo "  make docker-stop        - Stop Docker container"
	@echo "  make docker-logs        - View container logs"
	@echo "  make docker-push        - Push Docker image to registry"
	@echo "  make docker-clean       - Delete Docker image"
	@echo ""
	@echo "Other commands:"
	@echo "  make info               - Show project information"
	@echo "  make help               - Show this help message"
	@echo ""
	@echo "=================================================================================="
	@echo "Examples:"
	@echo "  # Quick start"
	@echo "  make build && make run"
	@echo ""
	@echo "  # Development mode"
	@echo "  make dev && make debug"
	@echo ""
	@echo "  # Docker deployment"
	@echo "  make docker-build && make docker-run"
	@echo "=================================================================================="

# ============================================================================
# Build targets
# ============================================================================
build: ## Build release version (optimized, recommended for production)
	@echo "üî® Building release version..."
	@$(CARGO) build --release
	@echo "‚úÖ Build complete!"
	@echo "üì¶ Binary location: $(RELEASE_BINARY)"

dev: ## Build development version (debug mode)
	@echo "üî® Building development version..."
	@$(CARGO) build
	@echo "‚úÖ Build complete!"
	@echo "üì¶ Binary location: $(DEBUG_BINARY)"

release: build ## Build release version and show path
	@echo "üì¶ Release binary:"
	@echo "   $(RELEASE_BINARY)"
	@ls -lh $(RELEASE_BINARY)

deps: ## Download and check dependencies
	@echo "üì• Downloading dependencies..."
	@$(CARGO) fetch
	@echo "‚úÖ Dependencies downloaded!"

update: ## Update all dependencies to latest compatible version
	@echo "üîÑ Updating dependencies..."
	@$(CARGO) update
	@echo "‚úÖ Dependencies updated!"

# ============================================================================
# Run targets
# ============================================================================
run: build ## Run release version using config file
	@echo "üöÄ Running with config file..."
	@if [ ! -f config.toml ]; then \
		echo "‚ö†Ô∏è  config.toml not found, using default config"; \
	fi
	@$(RELEASE_BINARY) --config config.toml


debug: dev ## Run development version (debug mode)
	@echo "üöÄ Running development version..."
	@$(DEBUG_BINARY) --config config.template.toml

# ============================================================================
# Test and check targets
# ============================================================================
test: ## Run all unit tests
	@echo "üß™ Running unit tests..."
	@$(CARGO) test --lib
	@echo "‚úÖ Tests complete!"

test-verbose: ## Run tests with detailed output
	@echo "üß™ Running unit tests (verbose output)..."
	@$(CARGO) test --lib -- --nocapture --test-threads=1

test-integration: ## Run integration tests
	@echo "üß™ Running integration tests..."
	@$(CARGO) test --test '*'

bench: ## Run benchmark tests
	@echo "üìä Running benchmark tests..."
	@$(CARGO) bench
	@echo "‚úÖ Benchmarks complete!"

fmt: ## Auto-format code
	@echo "üé® Formatting code..."
	@$(CARGO) fmt
	@echo "‚úÖ Code formatted!"

fmt-check: ## Check code format (no modifications)
	@echo "üîç Checking code format..."
	@$(CARGO) fmt -- --check
	@echo "‚úÖ Format check complete!"

lint: ## Run Clippy code check and optimization suggestions
	@echo "üîç Running Clippy check..."
	@$(CARGO) clippy -- -D warnings
	@echo "‚úÖ Clippy check complete!"

# ============================================================================
# Clean targets
# ============================================================================
clean: ## Delete build artifacts
	@echo "üßπ Cleaning build artifacts..."
	@$(CARGO) clean
	@echo "‚úÖ Cleanup complete!"

clean-db: ## Delete RocksDB data files (warning: deletes all local data)
	@echo "‚ö†Ô∏è  Deleting RocksDB data files..."
	@rm -rf data/rocksdb
	@echo "‚úÖ RocksDB data deleted!"

clean-all: clean clean-db ## Full cleanup (including dependencies and data)
	@echo "üßπ Full cleanup..."
	@$(CARGO) clean
	@rm -rf Cargo.lock
	@echo "‚úÖ Full cleanup complete!"

# ============================================================================
# Docker targets
# ============================================================================
docker-build: ## Build Docker image
	@echo "üê≥ Building Docker image..."
	@docker build -t $(DOCKER_IMAGE) .
	@echo "‚úÖ Docker image built!"
	@echo "üì¶ Image name: $(DOCKER_IMAGE)"

docker-run: docker-build ## Run Docker container
	@echo "üöÄ Running Docker container..."
	@docker run -d \
		--name moltrade-relayer \
		-p 8080:8080 \
		-p 9090:9090 \
		-v $(PWD)/data:/app/data \
		-e RUST_LOG=moltrade_relayer=info \
		$(DOCKER_IMAGE)
	@echo "‚úÖ Container started!"
	@echo "üåê REST API: http://localhost:8080"
	@echo "üìä Prometheus: http://localhost:9090"

docker-stop: ## Stop Docker container
	@echo "‚èπÔ∏è  Stopping Docker container..."
	@docker stop moltrade-relayer || true
	@docker rm moltrade-relayer || true
	@echo "‚úÖ Container stopped!"

docker-logs: ## View container logs
	@echo "üìã Container logs:"
	@docker logs -f moltrade-relayer

docker-push: docker-build ## Push Docker image to registry
	@echo "üì§ Pushing Docker image..."
	@docker push $(DOCKER_IMAGE)
	@echo "‚úÖ Image pushed!"

docker-clean: docker-stop ## Delete Docker image
	@echo "üßπ Deleting Docker image..."
	@docker rmi $(DOCKER_IMAGE) || true
	@echo "‚úÖ Image deleted!"

# ============================================================================
# Information targets
# ============================================================================
info: ## Display project information
	@echo ""
	@echo "=================================================================================="
	@echo "Project Information"
	@echo "=================================================================================="
	@echo "Project name: $(PROJECT_NAME)"
	@echo "Version: $(VERSION)"
	@echo "Rust version:"
	@$(CARGO) --version
	@echo "Cargo version:"
	@$(CARGO) --version
	@echo ""
	@echo "Project statistics:"
	@wc -l src/**/*.rs | tail -1
	@echo ""
	@echo "Dependency information:"
	@$(CARGO) tree --depth 1
	@echo ""
	@echo "=================================================================================="

# ============================================================================
# Development toolchain targets
# ============================================================================
install-tools: ## Install development toolchain
	@echo "üì• Installing development tools..."
	@rustup component add rustfmt clippy
	@$(CARGO) install cargo-deny cargo-audit
	@echo "‚úÖ Tools installed!"

security-audit: ## Check for security vulnerabilities
	@echo "üîê Checking dependency security vulnerabilities..."
	@$(CARGO) audit
	@echo "‚úÖ Security check complete!"

check-deps: ## Check dependency issues
	@echo "üîç Checking dependencies..."
	@$(CARGO) deny check
	@echo "‚úÖ Dependency check complete!"

# ============================================================================
# Performance analysis targets
# ============================================================================
perf: build ## Build performance analysis version
	@echo "üìä Building performance analysis version..."
	@$(CARGO) build --release --profile-timing
	@echo "‚úÖ Build complete!"

# ============================================================================
# Documentation targets
# ============================================================================
doc: ## Generate Rust documentation
	@echo "üìö Generating documentation..."
	@$(CARGO) doc --no-deps --open
	@echo "‚úÖ Documentation generated!"

# ============================================================================
# Shortcut commands
# ============================================================================
.PHONY: quick-test quick-build quick-run

quick-test: ## Quick test (skip dependency check)
	@$(CARGO) test --lib

quick-build: ## Quick build (incremental compilation)
	@$(CARGO) build --release

quick-run: quick-build ## Quick run
	@$(RELEASE_BINARY)

# ============================================================================
# Environment setup
# ============================================================================
.PHONY: setup-env

setup-env: ## Setup development environment
	@echo "üîß Setting up development environment..."
	@cp config.template.toml config.toml 2>/dev/null || echo "config.toml already exists"
	@mkdir -p data/rocksdb
	@echo "‚úÖ Environment setup complete!"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Edit config.toml configuration file"
	@echo "  2. Run 'make build' to compile the project"
	@echo "  3. Run 'make run' to start the service"

# ============================================================================
# Verification and checks
# ============================================================================
verify: fmt-check lint test ## Complete code verification (format, lint, tests)
	@echo "‚úÖ All verifications complete!"

# ============================================================================
# CI/CD targets
# ============================================================================
ci: verify build ## CI/CD process (verify + build)
	@echo "‚úÖ CI/CD process complete!"

# ============================================================================
# Build time analysis
# ============================================================================
time-build: ## Show detailed build time
	@echo "‚è±Ô∏è  Build time analysis..."
	@$(CARGO) build --release --timings
	@echo "üìä Time statistics saved to target/cargo-timings/cargo-timing-*.html"
